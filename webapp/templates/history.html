{% extends "base.html" %}

{% block title %}분석이력{% endblock %}

{% block content %}
<div x-data="analysisHistory()" x-init="loadHistory()">

    <!-- Page Header -->
    <div class="glass rounded-2xl p-6 shadow-lg mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">📋 분석 이력</h1>
        <p class="text-gray-600">최근 30회 분석 실행 기록</p>
    </div>

    <!-- Loading -->
    <div x-show="loading" class="flex justify-center items-center h-64">
        <div class="loading"></div>
    </div>

    <!-- History List -->
    <div x-show="!loading && history.length > 0" class="space-y-4">

        <!-- History Card -->
        <template x-for="(item, index) in history" :key="index">
            <div class="glass rounded-xl p-6 shadow-lg hover:shadow-xl transition-all cursor-pointer"
                 @click="viewRun(item.run_id)">

                <!-- Header -->
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm"
                             x-text="index + 1">
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800" x-text="item.date"></h3>
                            <p class="text-sm text-gray-500">목표일: <span x-text="item.target_date"></span></p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold"
                              :class="{
                                  'bg-green-100 text-green-700': item.status === 'completed',
                                  'bg-yellow-100 text-yellow-700': item.status === 'in_progress',
                                  'bg-red-100 text-red-700': item.status === 'failed'
                              }"
                              x-text="getStatusText(item.status)">
                        </span>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-white rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-500 mb-1">KOSPI</div>
                        <div class="text-sm font-bold text-gray-800" x-text="formatNumber(item.kospi)"></div>
                    </div>
                    <div class="bg-white rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-500 mb-1">센티먼트</div>
                        <div class="text-sm font-semibold"
                             :class="{
                                 'text-green-600': item.sentiment === 'BULLISH',
                                 'text-yellow-600': item.sentiment === 'NEUTRAL',
                                 'text-red-600': item.sentiment === 'BEARISH'
                             }"
                             x-text="item.sentiment || 'N/A'">
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-500 mb-1">매매신호</div>
                        <div class="text-sm font-bold text-blue-600" x-text="item.signals + '개'"></div>
                    </div>
                    <div class="bg-white rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-500 mb-1">Run ID</div>
                        <div class="text-sm font-mono text-gray-600" x-text="'#' + item.run_id"></div>
                    </div>
                </div>

            </div>
        </template>

    </div>

    <!-- Empty State -->
    <div x-show="!loading && history.length === 0" class="glass rounded-xl p-12 shadow-lg text-center">
        <div class="text-6xl mb-4">📋</div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">분석 이력이 없습니다</h3>
        <p class="text-gray-600">첫 분석을 실행하면 여기에 기록됩니다.</p>
    </div>

    <!-- View Run Details Modal (Simple) -->
    <div x-show="selectedRun"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-100"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
         @click.self="selectedRun = null">

        <div class="glass rounded-2xl p-6 max-w-md w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">분석 실행 #<span x-text="selectedRun"></span></h3>
            <p class="text-gray-600 mb-6">해당 분석의 상세 데이터를 보려면 메인 메뉴에서 해당 섹션으로 이동하세요.</p>
            <div class="space-y-2">
                <a href="/signals" class="block w-full text-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    💰 매매신호 보기
                </a>
                <a href="/ai-screening" class="block w-full text-center px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    🤖 AI 스크리닝 보기
                </a>
                <a href="/technical" class="block w-full text-center px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    📈 기술적분석 보기
                </a>
                <a href="/market" class="block w-full text-center px-4 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                    🌐 시장분석 보기
                </a>
                <button @click="selectedRun = null"
                        class="w-full px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                    닫기
                </button>
            </div>
        </div>
    </div>

</div>

<script>
function analysisHistory() {
    return {
        history: [],
        loading: false,
        selectedRun: null,

        async loadHistory() {
            this.loading = true;
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                this.history = data.history || [];
            } catch (error) {
                console.error('Error loading history:', error);
                alert('분석 이력을 불러오는데 실패했습니다.');
            } finally {
                this.loading = false;
            }
        },

        viewRun(runId) {
            this.selectedRun = runId;
        },

        getStatusText(status) {
            const statusMap = {
                'completed': '완료',
                'in_progress': '진행중',
                'failed': '실패',
                'pending': '대기'
            };
            return statusMap[status] || status;
        },

        formatNumber(num) {
            return new Intl.NumberFormat('ko-KR').format(num);
        }
    }
}
</script>
{% endblock %}
